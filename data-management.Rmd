---
title: "data-management"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_chunk$set(dev = 'pdf')
knitr::opts_chunk$set(fig.width=30, fig.height=20, out.width = "100%", out.height="1000px", dpi=200)
rm(list = ls())

library(tidyverse)
library(readxl)
library(dplyr)
library(tidyr)
library(reshape2)
```

```{r}
# Gather file paths
years <- list.files("data")
files <- dir(file.path("data", years), pattern="*ned.xlsx", full.names = TRUE)

# Read data
student <- files %>% 
  map(~read_excel(file.path(.), sheet="Student", skip=1)) %>% 
  reduce(rbind)
```

```{r warning=FALSE}
# Gather file paths
files <- dir(file.path("data", years), pattern="Original.*xlsx", full.names = TRUE)
# Read data
eventExcel <- files %>% 
  map(read_excel) %>% 
  reduce(rbind) %>% 
  select(`UoA ID`, `Tags`)

head(eventExcel, 10)
```

```{r}
# Gather file paths
files <- dir(file.path("data", years), pattern="Original.*csv", full.names = TRUE)
# Read data
eventCsv <- files %>% 
  map(read_csv) %>% 
  reduce(rbind) %>% 
  select(`UoA ID`, `Tags`)

head(eventCsv, 10)
```

```{r studentEvent warning=FALSE}
# Combine two data sets
studentEvent <- eventCsv %>% 
  rbind(eventExcel) %>% 
  group_by(`UoA ID`) %>% 
  mutate(events=str_length(Tags)) %>% # Count number of events
  filter(events==max(events)) # Latest rows would have higher number of events
# Participant programme
partProg <-studentEvent$Tags %>% 
  strsplit(., ",") %>% 
  setNames(studentEvent$`UoA ID`) %>% 
  melt(value.name = "programme")

colnames(partProg) <- c("programme", "ID")
```

```{r message=FALSE, warning=FALSE}
#TODO: Active in Programme?
partInfo <- student %>% 
  select(`ID`, `Acad Prog`, `Status`, `Descriptio`, `Acad Plan`, `Plan Description`, `Owner of Major/Spec/Module`)

head(partInfo,5)
```

```{r outer-join}
# Outer join two tables
df <- merge(x=partProg, y=partInfo, by="ID", all.x = TRUE)
# Filter out non-students
df_stud <- df %>% 
  filter(!is.na(`Acad Prog`))

head(df_stud,10)
```
